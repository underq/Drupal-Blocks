<?php

/**
 * Implementation of hook_menu().
 *
 * @return An array of menu items.
 */
function alg_block_menu() {
  $items = array();

  $items['page/1'] = array(
    'page callback' => '_alg_block_page_1',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * function callback for page 1
 *
 * @return boolean
 */
function _alg_block_page_1() {
  return 'Page NÂ°1';
}

/**
 * Implementation of hook_alg_block()
 */
function alg_bock_alg_block(){
  return array(
    'directory' => 'blocks',
  );
}

/**
 * Implementation of hook_block().
 *
 * @param $op What kind of information to retrieve about the block. Possible values: list, configure, save, view.
 * @param $delta Which block to return.
 * @param $edit Data from a configuration form, if submitted.
 */
function alg_block_block($op = 'list', $delta = 0, $edit = array()) {
  switch ($op) {
    case 'list':
      $blocks = array();
      $blocks += _alg_block_path_parser();
      return $blocks;
      break;

    case 'view':
      return _alg_blok_view_block($delta);
      if (file_exists($delta . '.inc')) {
        include 'blocks/' . $delta . '.inc';
        return $delta();
      }
  }
}

/**
 * Parse path for found all files and return blocks info
 * 
 * @return array
 */
function _alg_block_path_parser($path) {
  $results = array();

  foreach (module_implements('alg_block') as $module) { 
    // Get directory path where blocks files are defined
    $directory = module_invoke($module, 'alg_block');
    $path = drupal_get_path('module', $module) . '/' . $directory['directory'];
    
    $files = file_scan_directory($path, '\.inc$');
    foreach ($files as $file) {
      $block = array();
      if (_alg_block_comment_parser($file, $module, $block) !== FALSE) {
        $results += $block;
      }
    }
  }
  
  return $results;
}

/**
 * Parse comments and create an array of block parametres
 *
 * @param string $filename
 * @return array()
 */
function _alg_block_comment_parser($file, $module, &$block) {
  $result = array();
  $code = file_get_contents($file->filename);
  $pattern = '#@([a-zA-Z]*) ([\w-/ {\|}]*)#';
  if (preg_match_all($pattern, $code, $result) != 0) {
    if (!$block[$module . '-' . $file->name] = array_combine($result[1], str_replace('|', "\n", $result[2]))) {
      return FALSE;
    }
  }
  else {
    return FALSE;
  }
}

/**
 * Get the delta file fonction 
 */
function _alg_block_view_block($delta){
  // Explode delta's name for get module and filename
  $details = array();
  $details = explode('-', $delta,1);
  
  $directory = module_invoke($details[0], 'alg_block');
  $path = drupal_get_path('module', $details[0]) . '/' . $directory['directory'];
  $file = $path . '/' . $details[1] . '.inc';
  
  if (file_exists($file)) {
    include $file;
    return $details[1]();
  }
  return FALSE;
}